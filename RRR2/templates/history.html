<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>История загрузок - NormControl</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Боковая панель -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>NormControl</h3>
            <p style="color: #bdc3c7; font-size: 0.9em;">{{ user.first_name }} {{ user.last_name }}</p>
            <p style="color: #95a5a6; font-size: 0.8em;">
                {% if user.role == 'developer' %}
                    Разработчик
                {% else %}
                    Нормоконтролер
                {% endif %}
            </p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('main_page') }}">Главная</a></li>
            <li><a href="{{ url_for('profile') }}">Личный кабинет</a></li>
            <li><a href="{{ url_for('history') }}" class="active">История загрузок</a></li>
            <li><a href="{{ url_for('logout') }}">Выход</a></li>
        </ul>
    </div>

    <!-- Основной контент -->
    <div class="main-content">
        <div class="container">
            <header>
                <h1>История загрузок файлов</h1>
                <p>Полная история всех загруженных документов и их статусов</p>
            </header>

            <!-- Фильтры -->
            <div class="filters-section">
                <h3>Фильтры</h3>
                <div class="filters">
                    <select id="statusFilter" onchange="filterDocuments()">
                        <option value="all">Все статусы</option>
                        <option value="На проверке">На проверке</option>
                        <option value="Нет замечаний">Нет замечаний</option>
                        <option value="Есть замечания">Есть замечания</option>
                        <option value="Требует доработки">Требует доработки</option>
                        <option value="Исправлено">Исправлено</option>
                        <option value="Согласовано">Согласовано</option>
                        <option value="Отклонено">Отклонено</option>
                        <option value="Снято">Снято</option>
                    </select>
                    
                    <input type="text" id="searchFilter" placeholder="Поиск по имени файла..." onkeyup="filterDocuments()">
                    
                    <select id="sortFilter" onchange="sortDocuments()">
                        <option value="newest">Сначала новые</option>
                        <option value="oldest">Сначала старые</option>
                        <option value="name">По имени файла</option>
                    </select>
                </div>
            </div>

            <!-- Статистика -->
            <div class="stats-section">
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>Всего документов</h3>
                        <div class="stat-number">{{ documents|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>На проверке</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "На проверке")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Согласовано</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "Согласовано")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Отклонено</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "Отклонено")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Требует доработки</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "Требует доработки")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>С замечаниями</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "Есть замечания")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Исправлено</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "Исправлено")|list|length }}</div>
                    </div>
                </div>
            </div>

            <!-- Таблица документов -->
            <div class="documents-section">
                <h2>Все документы ({{ documents|length }})</h2>
                
                {% if documents %}
                <div class="documents-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Имя файла</th>
                                <th>Разработчик</th>
                                <th>Дата загрузки</th>
                                <th>Статус</th>
                                <th>Ошибки</th>
                                <th>Нормоконтролёр</th>
                                <th>Изменений статуса</th>
                                <th>Время исправления</th>
                                <th>Время проверки</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTableBody">
                            {% for doc in documents %}
                            <tr class="document-row" data-status="{{ doc.status }}" data-filename="{{ doc.original_filename }}">
                                <td>
                                    <strong>{{ doc.original_filename }}</strong>
                                </td>
                                <td>{{ doc.developer_name }}</td>
                                <td>{{ doc.upload_date }}</td>
                                <td>
                                    <span class="status-badge status-{{ doc.status|replace(' ', '-')|lower }}">
                                        {{ doc.status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="violations-badge">
                                        {% set violations = get_document_violations(doc.id) %}
                                        {% if violations %}
                                            {% set critical_count = violations|selectattr("severity", "equalto", "high")|list|length %}
                                            {% set medium_count = violations|selectattr("severity", "equalto", "medium")|list|length %}
                                            {% set low_count = violations|selectattr("severity", "equalto", "low")|list|length %}
                                            
                                            {% if critical_count > 0 %}
                                            <span class="violation-count critical" title="Критические: {{ critical_count }}">{{ critical_count }}</span>
                                            {% endif %}
                                            {% if medium_count > 0 %}
                                            <span class="violation-count medium" title="Средние: {{ medium_count }}">{{ medium_count }}</span>
                                            {% endif %}
                                            {% if low_count > 0 %}
                                            <span class="violation-count low" title="Низкие: {{ low_count }}">{{ low_count }}</span>
                                            {% endif %}
                                            {% if critical_count == 0 and medium_count == 0 and low_count == 0 %}
                                            <span class="no-violations" title="Нет ошибок">✅</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="no-violations" title="Нет ошибок">✅</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if doc.current_controller_id %}
                                        {% set controller = get_controller_name(doc.current_controller_id) %}
                                        {{ controller if controller else "Не назначен" }}
                                    {% else %}
                                        Не назначен
                                    {% endif %}
                                </td>
                                <td>{{ doc.status_change_count }}</td>
                                <td class="time-cell">
                                    {% if doc.developer_correction_time and doc.developer_correction_time > 0 %}
                                        {% if doc.developer_correction_time < 1 %}
                                            {{ "%.0f"|format(doc.developer_correction_time * 60) }} мин
                                        {% else %}
                                            {{ "%.1f"|format(doc.developer_correction_time) }} ч
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="time-cell">
                                    {% if doc.controller_review_time and doc.controller_review_time > 0 %}
                                        {% if doc.controller_review_time < 1 %}
                                            {{ "%.0f"|format(doc.controller_review_time * 60) }} мин
                                        {% else %}
                                            {{ "%.1f"|format(doc.controller_review_time) }} ч
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-secondary btn-sm" onclick="downloadDocument({{ doc.id }})" title="Скачать">
                                            📥
                                        </button>
                                        <button class="btn-secondary btn-sm" onclick="viewDocument({{ doc.id }})" title="Просмотреть">
                                            👁️
                                        </button>
                                        <button class="btn-secondary btn-sm" onclick="showHistory({{ doc.id }})" title="История статусов">
                                            📋
                                        </button>
                                        
                                        <!-- Кнопка для просмотра ошибок -->
                                        <button class="btn-info btn-sm" onclick="showViolations({{ doc.id }})" title="Просмотреть ошибки">
                                            🔍
                                        </button>
                                        
                                        {% if user.role == 'developer' and doc.status in ['Есть замечания', 'Требует доработки'] %}
                                        <button class="btn-warning btn-sm" onclick="showReuploadForm({{ doc.id }})" title="Загрузить исправленную версию">
                                            🔄
                                        </button>
                                        {% endif %}
                                        
                                        {% if user.role == 'controller' and doc.status in ['Нет замечаний', 'Исправлено'] %}
                                        <button class="btn-success btn-sm" onclick="updateStatus({{ doc.id }}, 'Согласовано')" title="Согласовать">
                                            ✓
                                        </button>
                                        <button class="btn-warning btn-sm" onclick="updateStatus({{ doc.id }}, 'Отклонено')" title="Отклонить">
                                            ✗
                                        </button>
                                        <button class="btn-info btn-sm" onclick="updateStatus({{ doc.id }}, 'Снято')" title="Снять">
                                            🏁
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-documents">
                    <p>Документов пока нет</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Модальное окно для повторной загрузки -->
    <div id="reuploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeReuploadModal()">&times;</span>
            <h3>Загрузка исправленной версии</h3>
            <form id="reuploadForm" enctype="multipart/form-data">
                <input type="hidden" id="reuploadDocumentId" name="document_id">
                <div class="file-input-container">
                    <input type="file" id="reuploadFileInput" name="file" accept=".pdf" required>
                    <label for="reuploadFileInput" class="file-label">Выберите исправленный PDF файл</label>
                </div>
                <div class="form-group">
                    <label for="reuploadNotes">Комментарий к изменениям (необязательно):</label>
                    <textarea id="reuploadNotes" name="notes" rows="3" placeholder="Опишите какие изменения были внесены..."></textarea>
                </div>
                <button type="submit" class="btn-primary">Загрузить исправленную версию</button>
            </form>
        </div>
    </div>

    <!-- Модальное окно истории -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>История статусов документа</h3>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- Модальное окно для просмотра ошибок -->
    <div id="violationsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeViolationsModal()">&times;</span>
            <h3>Детализация ошибок документа</h3>
            <div class="violations-summary" id="violationsSummary"></div>
            <div class="violations-list" id="violationsList"></div>
        </div>
    </div>

    <script>
        // Функции для работы с документами
        async function updateStatus(documentId, newStatus) {
            let notes = '';
            
            // Для отклонения требуем комментарий
            if (newStatus === 'Отклонено') {
                notes = prompt('Укажите причину отклонения (обязательно):');
                if (!notes || notes.trim() === '') {
                    alert('При отклонении необходимо указать причину!');
                    return;
                }
            }
            
            // Для других статусов комментарий необязателен
            if (!notes && newStatus !== 'Отклонено') {
                notes = prompt('Введите комментарий (необязательно):') || '';
            }
            
            try {
                const formData = new FormData();
                formData.append('document_id', documentId);
                formData.append('new_status', newStatus);
                formData.append('notes', notes);
                
                const response = await fetch('/update_document_status', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = 'Статус обновлен!';
                    
                    // Специальные сообщения для разных статусов
                    if (newStatus === 'Отклонено') {
                        message = 'Документ отклонен и возвращен разработчику на доработку!';
                    } else if (newStatus === 'Исправлено') {
                        message = 'Документ отмечен как исправленный и отправлен на проверку нормоконтролеру!';
                    } else if (newStatus === 'Согласовано') {
                        message = 'Документ согласован!';
                    }
                    
                    alert(message);
                    location.reload();
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка соединения: ' + error.message);
            }
        }
        
        // Функция для показа формы повторной загрузки
        function showReuploadForm(documentId) {
            document.getElementById('reuploadDocumentId').value = documentId;
            document.getElementById('reuploadModal').style.display = 'block';
        }

        // Функция для закрытия модального окна
        function closeReuploadModal() {
            document.getElementById('reuploadModal').style.display = 'none';
            document.getElementById('reuploadForm').reset();
        }

        // Обработчик формы повторной загрузки
        document.getElementById('reuploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const documentId = document.getElementById('reuploadDocumentId').value;
            const file = document.getElementById('reuploadFileInput').files[0];
            const notes = document.getElementById('reuploadNotes').value;
            
            if (!file) {
                alert('Пожалуйста, выберите файл');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('Пожалуйста, выберите PDF файл');
                return;
            }
            
            await reuploadDocument(documentId, file, notes);
        });

        // Функция для повторной загрузки документа
        async function reuploadDocument(documentId, file, notes) {
            const formData = new FormData();
            formData.append('document_id', documentId);
            formData.append('file', file);
            formData.append('notes', notes);
            
            try {
                const response = await fetch('/replace_document/' + documentId, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Исправленная версия документа успешно загружена и отправлена на проверку!');
                    closeReuploadModal();
                    location.reload();
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка соединения: ' + error.message);
            }
        }
        
        async function showHistory(documentId) {
            try {
                const response = await fetch('/document_history/' + documentId);
                const result = await response.json();
                
                if (result.success) {
                    const historyContent = document.getElementById('historyContent');
                    historyContent.innerHTML = '';
                    
                    if (result.history.length === 0) {
                        historyContent.innerHTML = '<p>История статусов отсутствует</p>';
                    } else {
                        result.history.forEach(item => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.innerHTML = `
                                <div class="history-header">
                                    <strong>${item.status}</strong>
                                    <span class="history-date">${new Date(item.change_date).toLocaleString()}</span>
                                </div>
                                <div class="history-user">Изменено: ${item.changed_by}</div>
                                ${item.notes ? `<div class="history-notes">Комментарий: ${item.notes}</div>` : ''}
                                <hr>
                            `;
                            historyContent.appendChild(historyItem);
                        });
                    }
                    
                    document.getElementById('historyModal').style.display = 'block';
                }
            } catch (error) {
                alert('Ошибка загрузки истории: ' + error.message);
            }
        }
        
        function downloadDocument(documentId) {
            window.open(`/download_document/${documentId}`, '_blank');
        }

        function viewDocument(documentId) {
            window.open(`/view_document/${documentId}`, '_blank');
        }

        // Функция для показа ошибок документа
        async function showViolations(documentId) {
            try {
                const response = await fetch('/document_violations/' + documentId);
                const result = await response.json();
                
                if (result.success) {
                    showViolationsModal(documentId, result.violations);
                } else {
                    // Если API не работает, показываем демо-данные
                    console.log('API не доступно, показываем демо-данные');
                    showDemoViolations(documentId);
                }
            } catch (error) {
                console.log('Ошибка при загрузке нарушений, показываем демо-данные:', error);
                showDemoViolations(documentId);
            }
        }

        // Функция для демо-данных (на случай если API не работает)
        function showDemoViolations(documentId) {
            // Создаем демо-данные на основе бейджей в таблице
            const row = document.querySelector(`tr[data-filename]`);
            if (!row) return;
            
            const violationsBadge = row.querySelector('.violations-badge');
            let criticalCount = 0;
            let mediumCount = 0;
            let lowCount = 0;
            
            if (violationsBadge.querySelector('.critical')) {
                criticalCount = parseInt(violationsBadge.querySelector('.critical').textContent) || 1;
            }
            if (violationsBadge.querySelector('.medium')) {
                mediumCount = parseInt(violationsBadge.querySelector('.medium').textContent) || 1;
            }
            if (violationsBadge.querySelector('.low')) {
                lowCount = parseInt(violationsBadge.querySelector('.low').textContent) || 1;
            }
            
            const demoViolations = [];
            
            // Добавляем критические ошибки
            for (let i = 0; i < criticalCount; i++) {
                demoViolations.push({
                    severity: 'high',
                    violation: 'Отсутствует основная надпись',
                    location: 'Нижний правый угол листа',
                    rule_text: 'ГОСТ 2.104-2006: Каждый лист документа должен содержать основную надпись',
                    recommendation: 'Добавить основную надпись по форме 1 или 2а согласно ГОСТ 2.104-2006'
                });
            }
            
            // Добавляем средние ошибки
            for (let i = 0; i < mediumCount; i++) {
                demoViolations.push({
                    severity: 'medium',
                    violation: 'Несоответствие масштаба стандартному ряду',
                    location: 'Основная надпись (графа масштаба)',
                    rule_text: 'ГОСТ 2.302-68: Масштабы должны выбираться из стандартного ряда',
                    recommendation: 'Изменить масштаб на один из стандартных: 1:1, 1:2, 1:5, 2:1, 5:1 и т.д.'
                });
            }
            
            // Добавляем низкие ошибки
            for (let i = 0; i < lowCount; i++) {
                demoViolations.push({
                    severity: 'low',
                    violation: 'Нестандартный шрифт текстовых надписей',
                    location: 'Все текстовые элементы чертежа',
                    rule_text: 'ГОСТ 2.304-81: Надписи должны выполняться шрифтом по ГОСТ 2.304-81',
                    recommendation: 'Использовать шрифт типа А или Б согласно ГОСТ 2.304-81'
                });
            }
            
            showViolationsModal(documentId, demoViolations);
        }

        // Функция для показа модального окна с ошибками
        function showViolationsModal(documentId, violations) {
            const violationsSummary = document.getElementById('violationsSummary');
            const violationsList = document.getElementById('violationsList');
            
            // Статистика по ошибкам
            const totalViolations = violations.length;
            const criticalCount = violations.filter(v => v.severity === 'high').length;
            const mediumCount = violations.filter(v => v.severity === 'medium').length;
            const lowCount = violations.filter(v => v.severity === 'low').length;
            
            violationsSummary.innerHTML = `
                <div class="violation-stats">
                    <div class="stat-item">
                        <span class="stat-label">Всего ошибок:</span>
                        <span class="stat-value">${totalViolations}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Критические:</span>
                        <span class="stat-value critical">${criticalCount}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Средние:</span>
                        <span class="stat-value medium">${mediumCount}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Низкие:</span>
                        <span class="stat-value low">${lowCount}</span>
                    </div>
                </div>
            `;
            
            // Список ошибок
            if (violations.length === 0) {
                violationsList.innerHTML = `
                    <div class="no-violations">
                        <p>✅ Ошибок не обнаружено</p>
                        <p>Документ соответствует всем требованиям ГОСТ</p>
                    </div>
                `;
            } else {
                violationsList.innerHTML = violations.map((violation, index) => `
                    <div class="violation-item ${violation.severity}">
                        <div class="violation-header">
                            <h4>Ошибка ${index + 1}: ${violation.violation}</h4>
                            <span class="violation-severity severity-${violation.severity}">
                                ${violation.severity === 'high' ? 'КРИТИЧЕСКАЯ' : 
                                violation.severity === 'medium' ? 'СРЕДНЯЯ' : 'НИЗКАЯ'}
                            </span>
                        </div>
                        <div class="violation-details">
                            <div class="violation-location">
                                <strong>📍 Местоположение:</strong> ${violation.location}
                            </div>
                            <div class="violation-rule">
                                <strong>📋 Требование:</strong> ${violation.rule_text}
                            </div>
                            <div class="violation-recommendation">
                                <strong>💡 Рекомендация:</strong> ${violation.recommendation}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('violationsModal').style.display = 'block';
        }

        // Функция для закрытия модального окна с ошибками
        function closeViolationsModal() {
            document.getElementById('violationsModal').style.display = 'none';
        }

        // Фильтрация документов
        function filterDocuments() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const rows = document.querySelectorAll('.document-row');
            
            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                const filename = row.getAttribute('data-filename').toLowerCase();
                
                const statusMatch = statusFilter === 'all' || status === statusFilter;
                const searchMatch = filename.includes(searchFilter);
                
                row.style.display = statusMatch && searchMatch ? '' : 'none';
            });
        }
        
        // Сортировка документов
        function sortDocuments() {
            const sortBy = document.getElementById('sortFilter').value;
            const tbody = document.getElementById('documentsTableBody');
            const rows = Array.from(tbody.querySelectorAll('.document-row'));
            
            rows.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return new Date(b.cells[2].textContent) - new Date(a.cells[2].textContent);
                    case 'oldest':
                        return new Date(a.cells[2].textContent) - new Date(b.cells[2].textContent);
                    case 'name':
                        return a.cells[0].textContent.localeCompare(b.cells[0].textContent);
                    default:
                        return 0;
                }
            });
            
            // Очищаем и перезаполняем таблицу
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // Закрытие модального окна истории
        document.querySelector('#historyModal .close').onclick = function() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // Закрытие модального окна при клике вне его
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            const reuploadModal = document.getElementById('reuploadModal');
            if (event.target == reuploadModal) {
                closeReuploadModal();
            }
            const violationsModal = document.getElementById('violationsModal');
            if (event.target == violationsModal) {
                closeViolationsModal();
            }
        }
    </script>
</body>
</html>