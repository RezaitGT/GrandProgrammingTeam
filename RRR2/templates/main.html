<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NormControl - –ì–ª–∞–≤–Ω–∞—è</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>NormControl</h3>
            <p style="color: #bdc3c7; font-size: 0.9em;">{{ user.first_name }} {{ user.last_name }}</p>
            <p style="color: #95a5a6; font-size: 0.8em;">
                {% if user.role == 'developer' %}
                    –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
                {% else %}
                    –ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä
                {% endif %}
            </p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('main_page') }}" class="active">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="{{ url_for('profile') }}">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
            <li><a href="{{ url_for('history') }}">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫</a></li>
            <li><a href="{{ url_for('logout') }}">–í—ã—Ö–æ–¥</a></li>
        </ul>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <div class="container">
            <header>
                <h1>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è —á–µ—Ä—Ç–µ–∂–µ–π</h1>
                <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ì–û–°–¢</p>
            </header>

            {% if user.role == 'developer' %}
            <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ -->
            <div class="upload-section">
                <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä—Ç–µ–∂–∞</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="file-input-container">
                        <input type="file" id="fileInput" name="file" accept=".pdf" required>
                        <label for="fileInput" class="file-label">–í—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª —á–µ—Ä—Ç–µ–∂–∞</label>
                    </div>
                    <button type="submit" class="btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </form>
            </div>

            <div id="progressSection" class="progress-section" style="display: none;">
                <h3>‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-steps">
                    <div class="step" id="step1">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</div>
                    <div class="step" id="step2">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏</div>
                    <div class="step" id="step3">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
                    <div class="step" id="step4">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª 1.1.1‚Äì1.1.8</div>
                    <div class="step" id="step5">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</div>
                </div>
            </div>

            <div id="resultsSection" class="results-section" style="display: none;">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
                <div class="summary-cards">
                    <div class="card">
                        <h3>–°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                        <div id="complianceStatus" class="status"></div>
                    </div>
                    <div class="card">
                        <h3>–í—Å–µ–≥–æ –∑–∞–º–µ—á–∞–Ω–∏–π</h3>
                        <div id="totalIssues" class="issues-count"></div>
                    </div>
                    <div class="card">
                        <h3>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ</h3>
                        <div id="criticalIssues" class="issues-critical"></div>
                    </div>
                </div>

                <div class="violations-list">
                    <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–º–µ—á–∞–Ω–∏–π</h3>
                    <div id="violationsContainer"></div>
                </div>

                <div class="actions">
                    <button id="downloadReport" class="btn-secondary" style="display: none;">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                    <button id="refreshList" class="btn-info" onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</button>
                    <button id="newCheck" class="btn-primary">üîÑ –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</button>
                </div>
            </div>

            <div id="errorSection" class="error-section" style="display: none;">
                <h3>‚ùå –û—à–∏–±–∫–∞</h3>
                <div id="errorMessage"></div>
                <button onclick="resetForm()" class="btn-primary">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>

            {% else %}
            <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞ -->
            <div class="controller-welcome">
                <div class="welcome-card">
                    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä!</h2>
                    <p>–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª <strong>"–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫"</strong>.</p>
                    <div class="welcome-actions">
                        <a href="{{ url_for('history') }}" class="btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º</a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
           <div class="quick-stats-main">
                <h2>–ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <h3>–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
                        <div class="stat-number">{{ documents|length }}</div>
                    </div>
                    {% if user.role == 'developer' %}
                    <div class="stat-card">
                        <div class="stat-icon">üõ†Ô∏è</div>
                        <h3>–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üîß</div>
                        <h3>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <h3>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ùå</div>
                        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <h3>–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÅ</div>
                        <h3>–°–Ω—è—Ç–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–°–Ω—è—Ç–æ")|list|length }}</div>
                    </div>
                    {% else %}
                    <div class="stat-card">
                        <div class="stat-icon">üìã</div>
                        <h3>–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "in", ["–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π", "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ"])|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <h3>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ùå</div>
                        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üõ†Ô∏è</div>
                        <h3>–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚ö†Ô∏è</div>
                        <h3>–° –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–ï—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <h3>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤</h3>
                        <div class="stat-number">{{ documents|map(attribute="developer_name")|unique|list|length }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="reuploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeReuploadModal()">&times;</span>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏</h3>
            <form id="reuploadForm" enctype="multipart/form-data">
                <input type="hidden" id="reuploadDocumentId" name="document_id">
                <div class="file-input-container">
                    <input type="file" id="reuploadFileInput" name="file" accept=".pdf" required>
                    <label for="reuploadFileInput" class="file-label">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π PDF —Ñ–∞–π–ª</label>
                </div>
                <div class="form-group">
                    <label for="reuploadNotes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <textarea id="reuploadNotes" name="notes" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã..."></textarea>
                </div>
                <button type="submit" class="btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
            <div id="historyContent"></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ (–¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º)
        async function updateStatus(documentId, newStatus) {
            let notes = '';
            
            // –î–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            if (newStatus === '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') {
                notes = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):');
                if (!notes || notes.trim() === '') {
                    alert('–ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É!');
                    return;
                }
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            if (!notes && newStatus !== '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') {
                notes = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
            }
            
            try {
                const formData = new FormData();
                formData.append('document_id', documentId);
                formData.append('new_status', newStatus);
                formData.append('notes', notes);
                
                const response = await fetch('/update_document_status', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!';
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
                    if (newStatus === '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') {
                        message = '–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É!';
                    } else if (newStatus === '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ') {
                        message = '–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—É!';
                    } else if (newStatus === '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ') {
                        message = '–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω!';
                    }
                    
                    alert(message);
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        function showReuploadForm(documentId) {
            document.getElementById('reuploadDocumentId').value = documentId;
            document.getElementById('reuploadModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeReuploadModal() {
            document.getElementById('reuploadModal').style.display = 'none';
            document.getElementById('reuploadForm').reset();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('reuploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const documentId = document.getElementById('reuploadDocumentId').value;
            const file = document.getElementById('reuploadFileInput').files[0];
            const notes = document.getElementById('reuploadNotes').value;
            
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }
            
            await reuploadDocument(documentId, file, notes);
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function reuploadDocument(documentId, file, notes) {
            const formData = new FormData();
            formData.append('document_id', documentId);
            formData.append('file', file);
            formData.append('notes', notes);
            
            try {
                const response = await fetch('/replace_document/' + documentId, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!');
                    closeReuploadModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        async function showHistory(documentId) {
            try {
                const response = await fetch('/document_history/' + documentId);
                const result = await response.json();
                
                if (result.success) {
                    const historyContent = document.getElementById('historyContent');
                    historyContent.innerHTML = '';
                    
                    if (result.history.length === 0) {
                        historyContent.innerHTML = '<p>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>';
                    } else {
                        result.history.forEach(item => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.innerHTML = `
                                <div class="history-header">
                                    <strong>${item.status}</strong>
                                    <span class="history-date">${new Date(item.change_date).toLocaleString()}</span>
                                </div>
                                <div class="history-user">–ò–∑–º–µ–Ω–µ–Ω–æ: ${item.changed_by}</div>
                                ${item.notes ? `<div class="history-notes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${item.notes}</div>` : ''}
                                <hr>
                            `;
                            historyContent.appendChild(historyItem);
                        });
                    }
                    
                    document.getElementById('historyModal').style.display = 'block';
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
            }
        }
        
        function downloadDocument(documentId) {
            window.open(`/download_document/${documentId}`, '_blank');
        }

        function viewDocument(documentId) {
            window.open(`/view_document/${documentId}`, '_blank');
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.querySelector('.close').onclick = function() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            const reuploadModal = document.getElementById('reuploadModal');
            if (event.target == reuploadModal) {
                closeReuploadModal();
            }
        }

        {% if user.role == 'developer' %}
        // JavaScript —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = document.getElementById('fileInput').files[0];
            if (!file) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }
            if (file.type !== 'application/pdf') {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }
            await uploadAndAnalyze(file);
        });

        async function uploadAndAnalyze(file) {
            showProgress();
            updateProgress(20, 1);

            const formData = new FormData();
            formData.append('file', file);

            try {
                updateProgress(40, 2);
                const response = await fetch('/analyze_document', {
                    method: 'POST',
                    body: formData
                });

                updateProgress(80, 4);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }

                updateProgress(100, 5);
                setTimeout(() => {
                    showResults(result.result);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å—Ç–∞—Ç—É—Å
                    const statusMessage = result.auto_status === '–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π' 
                        ? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ–∫—É–º–µ–Ω—Ç –ø–µ—Ä–µ–¥–∞–Ω –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—É.' 
                        : '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–º–µ—á–∞–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é.';
                    
                    alert(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n–°—Ç–∞—Ç—É—Å: ${result.auto_status}\n\n${statusMessage}`);
                    
                }, 500);
            } catch (error) {
                showError(error.message);
            }
        }

        function showProgress() {
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
        }

        function updateProgress(percent, activeStep) {
            document.getElementById('progressFill').style.width = `${percent}%`;
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (i <= activeStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            }
        }

        function showResults(result) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            // –°—Ç–∞—Ç—É—Å
            const statusEl = document.getElementById('complianceStatus');
            statusEl.textContent = result.is_compliant ? '–°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢' : '–ù–ï –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢';
            statusEl.className = result.is_compliant ? 'status compliant' : 'status non-compliant';

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            document.getElementById('totalIssues').textContent = result.statistics.total_violations;
            document.getElementById('criticalIssues').textContent = result.statistics.high_severity;

            // –ó–∞–º–µ—á–∞–Ω–∏—è
            const container = document.getElementById('violationsContainer');
            container.innerHTML = '';

            if (result.violations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #d4edda; border-radius: 8px;">
                        <h3 style="color: #155724;">‚úÖ –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</h3>
                        <p>–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ì–û–°–¢</p>
                    </div>
                `;
            } else {
                result.violations.forEach((v, i) => {
                    const el = document.createElement('div');
                    el.className = `violation-item ${v.severity}`;
                    const severityText = v.severity === 'high' ? '–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï' : 
                                        v.severity === 'medium' ? '–°–†–ï–î–ù–ï–ï' : '–ù–ò–ó–ö–û–ï';
                    const severityColor = v.severity === 'high' ? '#dc3545' : 
                                         v.severity === 'medium' ? '#ffc107' : '#17a2b8';

                    el.innerHTML = `
                        <div class="violation-header">
                            <h4>–ó–∞–º–µ—á–∞–Ω–∏–µ ${i + 1}: ${v.violation}</h4>
                            <span class="violation-severity" style="background: ${severityColor}">${severityText}</span>
                        </div>
                        <div class="violation-location"><strong>üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> ${v.location}</div>
                        <div class="violation-rule"><strong>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:</strong> ${v.rule_text}</div>
                        <div class="violation-recommendation"><strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${v.recommendation}</div>
                    `;
                    container.appendChild(el);
                });
            }

            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('newCheck').onclick = resetForm;
            document.getElementById('downloadReport').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function resetForm() {
            document.getElementById('uploadForm').style.display = 'block';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            // –ü—Ä–∏ –Ω–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            location.reload();
        }
        {% endif %}
    </script>
</body>
</html>