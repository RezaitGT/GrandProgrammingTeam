<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫ - NormControl</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>NormControl</h3>
            <p style="color: #bdc3c7; font-size: 0.9em;">{{ user.first_name }} {{ user.last_name }}</p>
            <p style="color: #95a5a6; font-size: 0.8em;">
                {% if user.role == 'developer' %}
                    –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
                {% else %}
                    –ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä
                {% endif %}
            </p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="{{ url_for('main_page') }}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="{{ url_for('profile') }}">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a></li>
            <li><a href="{{ url_for('history') }}" class="active">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫</a></li>
            <li><a href="{{ url_for('logout') }}">–í—ã—Ö–æ–¥</a></li>
        </ul>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <div class="container">
            <header>
                <h1>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫ —Ñ–∞–π–ª–æ–≤</h1>
                <p>–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤</p>
            </header>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters-section">
                <h3>–§–∏–ª—å—Ç—Ä—ã</h3>
                <div class="filters">
                    <select id="statusFilter" onchange="filterDocuments()">
                        <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</option>
                        <option value="–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π">–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π</option>
                        <option value="–ï—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è">–ï—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è</option>
                        <option value="–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏">–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</option>
                        <option value="–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ">–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                        <option value="–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ">–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</option>
                        <option value="–û—Ç–∫–ª–æ–Ω–µ–Ω–æ">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                        <option value="–°–Ω—è—Ç–æ">–°–Ω—è—Ç–æ</option>
                    </select>
                    
                    <input type="text" id="searchFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞..." onkeyup="filterDocuments()">
                    
                    <select id="sortFilter" onchange="sortDocuments()">
                        <option value="newest">–°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                        <option value="oldest">–°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                        <option value="name">–ü–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞</option>
                    </select>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="stats-section">
                <div class="stats-cards">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
                        <div class="stat-number">{{ documents|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–° –∑–∞–º–µ—á–∞–Ω–∏—è–º–∏</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–ï—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è")|list|length }}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ</h3>
                        <div class="stat-number">{{ documents|selectattr("status", "equalto", "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ")|list|length }}</div>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="documents-section">
                <h2>–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ({{ documents|length }})</h2>
                
                {% if documents %}
                <div class="documents-table">
                    <table>
                        <thead>
                            <tr>
                                <th>–ò–º—è —Ñ–∞–π–ª–∞</th>
                                <th>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</th>
                                <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–û—à–∏–±–∫–∏</th>
                                <th>–ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä</th>
                                <th>–ò–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞</th>
                                <th>–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è</th>
                                <th>–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTableBody">
                            {% for doc in documents %}
                            <tr class="document-row" data-status="{{ doc.status }}" data-filename="{{ doc.original_filename }}">
                                <td>
                                    <strong>{{ doc.original_filename }}</strong>
                                </td>
                                <td>{{ doc.developer_name }}</td>
                                <td>{{ doc.upload_date }}</td>
                                <td>
                                    <span class="status-badge status-{{ doc.status|replace(' ', '-')|lower }}">
                                        {{ doc.status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="violations-badge">
                                        {% set violations = get_document_violations(doc.id) %}
                                        {% if violations %}
                                            {% set critical_count = violations|selectattr("severity", "equalto", "high")|list|length %}
                                            {% set medium_count = violations|selectattr("severity", "equalto", "medium")|list|length %}
                                            {% set low_count = violations|selectattr("severity", "equalto", "low")|list|length %}
                                            
                                            {% if critical_count > 0 %}
                                            <span class="violation-count critical" title="–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ: {{ critical_count }}">{{ critical_count }}</span>
                                            {% endif %}
                                            {% if medium_count > 0 %}
                                            <span class="violation-count medium" title="–°—Ä–µ–¥–Ω–∏–µ: {{ medium_count }}">{{ medium_count }}</span>
                                            {% endif %}
                                            {% if low_count > 0 %}
                                            <span class="violation-count low" title="–ù–∏–∑–∫–∏–µ: {{ low_count }}">{{ low_count }}</span>
                                            {% endif %}
                                            {% if critical_count == 0 and medium_count == 0 and low_count == 0 %}
                                            <span class="no-violations" title="–ù–µ—Ç –æ—à–∏–±–æ–∫">‚úÖ</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="no-violations" title="–ù–µ—Ç –æ—à–∏–±–æ–∫">‚úÖ</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if doc.current_controller_id %}
                                        {% set controller = get_controller_name(doc.current_controller_id) %}
                                        {{ controller if controller else "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω" }}
                                    {% else %}
                                        –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                                    {% endif %}
                                </td>
                                <td>{{ doc.status_change_count }}</td>
                                <td class="time-cell">
                                    {% if doc.developer_correction_time and doc.developer_correction_time > 0 %}
                                        {% if doc.developer_correction_time < 1 %}
                                            {{ "%.0f"|format(doc.developer_correction_time * 60) }} –º–∏–Ω
                                        {% else %}
                                            {{ "%.1f"|format(doc.developer_correction_time) }} —á
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="time-cell">
                                    {% if doc.controller_review_time and doc.controller_review_time > 0 %}
                                        {% if doc.controller_review_time < 1 %}
                                            {{ "%.0f"|format(doc.controller_review_time * 60) }} –º–∏–Ω
                                        {% else %}
                                            {{ "%.1f"|format(doc.controller_review_time) }} —á
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-secondary btn-sm" onclick="downloadDocument({{ doc.id }})" title="–°–∫–∞—á–∞—Ç—å">
                                            üì•
                                        </button>
                                        <button class="btn-secondary btn-sm" onclick="viewDocument({{ doc.id }})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å">
                                            üëÅÔ∏è
                                        </button>
                                        <button class="btn-secondary btn-sm" onclick="showHistory({{ doc.id }})" title="–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤">
                                            üìã
                                        </button>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—à–∏–±–æ–∫ -->
                                        <button class="btn-info btn-sm" onclick="showViolations({{ doc.id }})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—à–∏–±–∫–∏">
                                            üîç
                                        </button>
                                        
                                        {% if user.role == 'developer' and doc.status in ['–ï—Å—Ç—å –∑–∞–º–µ—á–∞–Ω–∏—è', '–¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏'] %}
                                        <button class="btn-warning btn-sm" onclick="showReuploadForm({{ doc.id }})" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é">
                                            üîÑ
                                        </button>
                                        {% endif %}
                                        
                                        {% if user.role == 'controller' and doc.status in ['–ù–µ—Ç –∑–∞–º–µ—á–∞–Ω–∏–π', '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ'] %}
                                        <button class="btn-success btn-sm" onclick="updateStatus({{ doc.id }}, '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ')" title="–°–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å">
                                            ‚úì
                                        </button>
                                        <button class="btn-warning btn-sm" onclick="updateStatus({{ doc.id }}, '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ')" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">
                                            ‚úó
                                        </button>
                                        <button class="btn-info btn-sm" onclick="updateStatus({{ doc.id }}, '–°–Ω—è—Ç–æ')" title="–°–Ω—è—Ç—å">
                                            üèÅ
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-documents">
                    <p>–î–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="reuploadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeReuploadModal()">&times;</span>
            <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏</h3>
            <form id="reuploadForm" enctype="multipart/form-data">
                <input type="hidden" id="reuploadDocumentId" name="document_id">
                <div class="file-input-container">
                    <input type="file" id="reuploadFileInput" name="file" accept=".pdf" required>
                    <label for="reuploadFileInput" class="file-label">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π PDF —Ñ–∞–π–ª</label>
                </div>
                <div class="form-group">
                    <label for="reuploadNotes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <textarea id="reuploadNotes" name="notes" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ –≤–Ω–µ—Å–µ–Ω—ã..."></textarea>
                </div>
                <button type="submit" class="btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é</button>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ -->
    <div id="historyModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
            <div id="historyContent"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—à–∏–±–æ–∫ -->
    <div id="violationsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeViolationsModal()">&times;</span>
            <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h3>
            <div class="violations-summary" id="violationsSummary"></div>
            <div class="violations-list" id="violationsList"></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
        async function updateStatus(documentId, newStatus) {
            let notes = '';
            
            // –î–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            if (newStatus === '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') {
                notes = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):');
                if (!notes || notes.trim() === '') {
                    alert('–ü—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É!');
                    return;
                }
            }
            
            // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            if (!notes && newStatus !== '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') {
                notes = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
            }
            
            try {
                const formData = new FormData();
                formData.append('document_id', documentId);
                formData.append('new_status', newStatus);
                formData.append('notes', notes);
                
                const response = await fetch('/update_document_status', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = '–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!';
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
                    if (newStatus === '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ') {
                        message = '–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É!';
                    } else if (newStatus === '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ') {
                        message = '–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—É!';
                    } else if (newStatus === '–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ') {
                        message = '–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω!';
                    }
                    
                    alert(message);
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ñ–æ—Ä–º—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        function showReuploadForm(documentId) {
            document.getElementById('reuploadDocumentId').value = documentId;
            document.getElementById('reuploadModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeReuploadModal() {
            document.getElementById('reuploadModal').style.display = 'none';
            document.getElementById('reuploadForm').reset();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('reuploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const documentId = document.getElementById('reuploadDocumentId').value;
            const file = document.getElementById('reuploadFileInput').files[0];
            const notes = document.getElementById('reuploadNotes').value;
            
            if (!file) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }
            
            await reuploadDocument(documentId, file, notes);
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function reuploadDocument(documentId, file, notes) {
            const formData = new FormData();
            formData.append('document_id', documentId);
            formData.append('file', file);
            formData.append('notes', notes);
            
            try {
                const response = await fetch('/replace_document/' + documentId, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!');
                    closeReuploadModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        async function showHistory(documentId) {
            try {
                const response = await fetch('/document_history/' + documentId);
                const result = await response.json();
                
                if (result.success) {
                    const historyContent = document.getElementById('historyContent');
                    historyContent.innerHTML = '';
                    
                    if (result.history.length === 0) {
                        historyContent.innerHTML = '<p>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>';
                    } else {
                        result.history.forEach(item => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'history-item';
                            historyItem.innerHTML = `
                                <div class="history-header">
                                    <strong>${item.status}</strong>
                                    <span class="history-date">${new Date(item.change_date).toLocaleString()}</span>
                                </div>
                                <div class="history-user">–ò–∑–º–µ–Ω–µ–Ω–æ: ${item.changed_by}</div>
                                ${item.notes ? `<div class="history-notes">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${item.notes}</div>` : ''}
                                <hr>
                            `;
                            historyContent.appendChild(historyItem);
                        });
                    }
                    
                    document.getElementById('historyModal').style.display = 'block';
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + error.message);
            }
        }
        
        function downloadDocument(documentId) {
            window.open(`/download_document/${documentId}`, '_blank');
        }

        function viewDocument(documentId) {
            window.open(`/view_document/${documentId}`, '_blank');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        async function showViolations(documentId) {
            try {
                const response = await fetch('/document_violations/' + documentId);
                const result = await response.json();
                
                if (result.success) {
                    showViolationsModal(documentId, result.violations);
                } else {
                    // –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                    console.log('API –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ');
                    showDemoViolations(documentId);
                }
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Ä—É—à–µ–Ω–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ:', error);
                showDemoViolations(documentId);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
        function showDemoViolations(documentId) {
            // –°–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–µ–π–¥–∂–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
            const row = document.querySelector(`tr[data-filename]`);
            if (!row) return;
            
            const violationsBadge = row.querySelector('.violations-badge');
            let criticalCount = 0;
            let mediumCount = 0;
            let lowCount = 0;
            
            if (violationsBadge.querySelector('.critical')) {
                criticalCount = parseInt(violationsBadge.querySelector('.critical').textContent) || 1;
            }
            if (violationsBadge.querySelector('.medium')) {
                mediumCount = parseInt(violationsBadge.querySelector('.medium').textContent) || 1;
            }
            if (violationsBadge.querySelector('.low')) {
                lowCount = parseInt(violationsBadge.querySelector('.low').textContent) || 1;
            }
            
            const demoViolations = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
            for (let i = 0; i < criticalCount; i++) {
                demoViolations.push({
                    severity: 'high',
                    violation: '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–¥–ø–∏—Å—å',
                    location: '–ù–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª –ª–∏—Å—Ç–∞',
                    rule_text: '–ì–û–°–¢ 2.104-2006: –ö–∞–∂–¥—ã–π –ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –Ω–∞–¥–ø–∏—Å—å',
                    recommendation: '–î–æ–±–∞–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –Ω–∞–¥–ø–∏—Å—å –ø–æ —Ñ–æ—Ä–º–µ 1 –∏–ª–∏ 2–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –ì–û–°–¢ 2.104-2006'
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏
            for (let i = 0; i < mediumCount; i++) {
                demoViolations.push({
                    severity: 'medium',
                    violation: '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –º–∞—Å—à—Ç–∞–±–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ä—è–¥—É',
                    location: '–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–¥–ø–∏—Å—å (–≥—Ä–∞—Ñ–∞ –º–∞—Å—à—Ç–∞–±–∞)',
                    rule_text: '–ì–û–°–¢ 2.302-68: –ú–∞—Å—à—Ç–∞–±—ã –¥–æ–ª–∂–Ω—ã –≤—ã–±–∏—Ä–∞—Ç—å—Å—è –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Ä—è–¥–∞',
                    recommendation: '–ò–∑–º–µ–Ω–∏—Ç—å –º–∞—Å—à—Ç–∞–± –Ω–∞ –æ–¥–∏–Ω –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö: 1:1, 1:2, 1:5, 2:1, 5:1 –∏ —Ç.–¥.'
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∏–∑–∫–∏–µ –æ—à–∏–±–∫–∏
            for (let i = 0; i < lowCount; i++) {
                demoViolations.push({
                    severity: 'low',
                    violation: '–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –Ω–∞–¥–ø–∏—Å–µ–π',
                    location: '–í—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä—Ç–µ–∂–∞',
                    rule_text: '–ì–û–°–¢ 2.304-81: –ù–∞–¥–ø–∏—Å–∏ –¥–æ–ª–∂–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —à—Ä–∏—Ñ—Ç–æ–º –ø–æ –ì–û–°–¢ 2.304-81',
                    recommendation: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à—Ä–∏—Ñ—Ç —Ç–∏–ø–∞ –ê –∏–ª–∏ –ë —Å–æ–≥–ª–∞—Å–Ω–æ –ì–û–°–¢ 2.304-81'
                });
            }
            
            showViolationsModal(documentId, demoViolations);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏
        function showViolationsModal(documentId, violations) {
            const violationsSummary = document.getElementById('violationsSummary');
            const violationsList = document.getElementById('violationsList');
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—à–∏–±–∫–∞–º
            const totalViolations = violations.length;
            const criticalCount = violations.filter(v => v.severity === 'high').length;
            const mediumCount = violations.filter(v => v.severity === 'medium').length;
            const lowCount = violations.filter(v => v.severity === 'low').length;
            
            violationsSummary.innerHTML = `
                <div class="violation-stats">
                    <div class="stat-item">
                        <span class="stat-label">–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫:</span>
                        <span class="stat-value">${totalViolations}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:</span>
                        <span class="stat-value critical">${criticalCount}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–°—Ä–µ–¥–Ω–∏–µ:</span>
                        <span class="stat-value medium">${mediumCount}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ù–∏–∑–∫–∏–µ:</span>
                        <span class="stat-value low">${lowCount}</span>
                    </div>
                </div>
            `;
            
            // –°–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
            if (violations.length === 0) {
                violationsList.innerHTML = `
                    <div class="no-violations">
                        <p>‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</p>
                        <p>–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ì–û–°–¢</p>
                    </div>
                `;
            } else {
                violationsList.innerHTML = violations.map((violation, index) => `
                    <div class="violation-item ${violation.severity}">
                        <div class="violation-header">
                            <h4>–û—à–∏–±–∫–∞ ${index + 1}: ${violation.violation}</h4>
                            <span class="violation-severity severity-${violation.severity}">
                                ${violation.severity === 'high' ? '–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø' : 
                                violation.severity === 'medium' ? '–°–†–ï–î–ù–Ø–Ø' : '–ù–ò–ó–ö–ê–Ø'}
                            </span>
                        </div>
                        <div class="violation-details">
                            <div class="violation-location">
                                <strong>üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> ${violation.location}
                            </div>
                            <div class="violation-rule">
                                <strong>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:</strong> ${violation.rule_text}
                            </div>
                            <div class="violation-recommendation">
                                <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${violation.recommendation}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('violationsModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –æ—à–∏–±–∫–∞–º–∏
        function closeViolationsModal() {
            document.getElementById('violationsModal').style.display = 'none';
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        function filterDocuments() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const rows = document.querySelectorAll('.document-row');
            
            rows.forEach(row => {
                const status = row.getAttribute('data-status');
                const filename = row.getAttribute('data-filename').toLowerCase();
                
                const statusMatch = statusFilter === 'all' || status === statusFilter;
                const searchMatch = filename.includes(searchFilter);
                
                row.style.display = statusMatch && searchMatch ? '' : 'none';
            });
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        function sortDocuments() {
            const sortBy = document.getElementById('sortFilter').value;
            const tbody = document.getElementById('documentsTableBody');
            const rows = Array.from(tbody.querySelectorAll('.document-row'));
            
            rows.sort((a, b) => {
                switch(sortBy) {
                    case 'newest':
                        return new Date(b.cells[2].textContent) - new Date(a.cells[2].textContent);
                    case 'oldest':
                        return new Date(a.cells[2].textContent) - new Date(b.cells[2].textContent);
                    case 'name':
                        return a.cells[0].textContent.localeCompare(b.cells[0].textContent);
                    default:
                        return 0;
                }
            });
            
            // –û—á–∏—â–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏
        document.querySelector('#historyModal .close').onclick = function() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('historyModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
            const reuploadModal = document.getElementById('reuploadModal');
            if (event.target == reuploadModal) {
                closeReuploadModal();
            }
            const violationsModal = document.getElementById('violationsModal');
            if (event.target == violationsModal) {
                closeViolationsModal();
            }
        }
    </script>
</body>
</html>