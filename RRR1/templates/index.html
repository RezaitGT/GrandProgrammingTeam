<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å —á–µ—Ä—Ç–µ–∂–µ–π</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –Ω–æ—Ä–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è —á–µ—Ä—Ç–µ–∂–µ–π</h1>
            <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ì–û–°–¢</p>
        </header>

        <div class="upload-section">
            <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä—Ç–µ–∂–∞</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-container">
                    <input type="file" id="fileInput" name="file" accept=".pdf" required>
                    <label for="fileInput" class="file-label">–í—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª —á–µ—Ä—Ç–µ–∂–∞</label>
                </div>
                <button type="submit" class="btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            </form>
        </div>

        <div id="progressSection" class="progress-section" style="display: none;">
            <h3>‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
                <div class="step" id="step1">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</div>
                <div class="step" id="step2">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</div>
                <div class="step" id="step3">–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</div>
                <div class="step" id="step4">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª</div>
                <div class="step" id="step5">–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞</div>
            </div>
        </div>

        <!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ë–ª–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
        <div id="blocksSection" class="blocks-section" style="display: none;">
            <h2>üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
            <div class="blocks-container">
                <div class="block-card">
                    <h3>üìê –ß–µ—Ä—Ç–µ–∂</h3>
                    <div class="block-stats" id="drawingStats"></div>
                    <div class="block-preview" id="drawingPreview"></div>
                </div>
                <div class="block-card">
                    <h3>üìù –û–ø–∏—Å–∞–Ω–∏–µ</h3>
                    <div class="block-stats" id="descriptionStats"></div>
                    <div class="block-preview" id="descriptionPreview"></div>
                </div>
                <div class="block-card">
                    <h3>üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞</h3>
                    <div class="block-stats" id="structureStats"></div>
                    <div class="block-preview" id="structurePreview"></div>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="results-section" style="display: none;">
            <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h2>
            <div class="summary-cards">
                <div class="card">
                    <h3>–°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</h3>
                    <div id="complianceStatus" class="status"></div>
                </div>
                <div class="card">
                    <h3>–í—Å–µ–≥–æ –∑–∞–º–µ—á–∞–Ω–∏–π</h3>
                    <div id="totalIssues" class="issues-count"></div>
                </div>
                <div class="card">
                    <h3>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ</h3>
                    <div id="criticalIssues" class="issues-critical"></div>
                </div>
            </div>

            <div class="violations-list">
                <h3>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–º–µ—á–∞–Ω–∏–π</h3>
                <div id="violationsContainer"></div>
            </div>

            <div class="actions">
                <button id="downloadReport" class="btn-secondary">üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                <button id="newCheck" class="btn-primary">üîÑ –ù–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞</button>
            </div>
        </div>

        <div id="errorSection" class="error-section" style="display: none;">
            <h3>‚ùå –û—à–∏–±–∫–∞</h3>
            <div id="errorMessage"></div>
            <button onclick="resetForm()" class="btn-primary">üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
    </div>

    <script>
        let currentAnalysisData = null;

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª');
                return;
            }
            
            await uploadAndAnalyze(file);
        });

        async function uploadAndAnalyze(file) {
            showProgress();
            updateProgress(10, 1);
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                updateProgress(30, 2);
                
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                updateProgress(60, 3);
                updateProgress(80, 4);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞');
                }
                
                const result = await response.json();
                
                updateProgress(100, 5);
                
                setTimeout(() => {
                    showResults(result);
                }, 1000);
                
            } catch (error) {
                showError(error.message);
            }
        }

        function showProgress() {
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('blocksSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
        }

        function updateProgress(percent, activeStep) {
            document.getElementById('progressFill').style.width = percent + '%';
            
            // Update active steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById('step' + i);
                if (i <= activeStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            }
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        function showBlocksInfo(blocksInfo) {
            const blocksSection = document.getElementById('blocksSection');
            
            if (blocksInfo && (blocksInfo.drawing || blocksInfo.description || blocksInfo.structure)) {
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–ª–æ–∫–æ–≤
                document.getElementById('drawingStats').innerHTML = `
                    <strong>–°–∏–º–≤–æ–ª–æ–≤:</strong> ${blocksInfo.drawing?.length || 0}<br>
                    <strong>–°–ª–æ–≤:</strong> ${blocksInfo.drawing?.split(/\s+/).filter(w => w).length || 0}
                `;
                
                document.getElementById('descriptionStats').innerHTML = `
                    <strong>–°–∏–º–≤–æ–ª–æ–≤:</strong> ${blocksInfo.description?.length || 0}<br>
                    <strong>–°–ª–æ–≤:</strong> ${blocksInfo.description?.split(/\s+/).filter(w => w).length || 0}
                `;
                
                document.getElementById('structureStats').innerHTML = `
                    <strong>–°–∏–º–≤–æ–ª–æ–≤:</strong> ${blocksInfo.structure?.length || 0}<br>
                    <strong>–°–ª–æ–≤:</strong> ${blocksInfo.structure?.split(/\s+/).filter(w => w).length || 0}
                `;
                
                // –ü—Ä–µ–≤—å—é –±–ª–æ–∫–æ–≤
                document.getElementById('drawingPreview').textContent = 
                    blocksInfo.drawing?.substring(0, 200) + (blocksInfo.drawing?.length > 200 ? '...' : '') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    
                document.getElementById('descriptionPreview').textContent = 
                    blocksInfo.description?.substring(0, 200) + (blocksInfo.description?.length > 200 ? '...' : '') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                    
                document.getElementById('structurePreview').textContent = 
                    blocksInfo.structure?.substring(0, 200) + (blocksInfo.structure?.length > 200 ? '...' : '') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                
                blocksSection.style.display = 'block';
            }
        }

        function showResults(result) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            
            const analysisResult = result.analysis_result;
            currentAnalysisData = result;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            if (result.blocks_info) {
                showBlocksInfo(result.blocks_info);
            }
            
            // Update summary
            document.getElementById('complianceStatus').textContent = 
                analysisResult.is_compliant ? '–°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢' : '–ù–ï –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢';
            document.getElementById('complianceStatus').className = 
                analysisResult.is_compliant ? 'status compliant' : 'status non-compliant';
            
            document.getElementById('totalIssues').textContent = 
                analysisResult.statistics.total_violations;
            document.getElementById('criticalIssues').textContent = 
                analysisResult.statistics.high_severity;
            
            // Display violations
            const violationsContainer = document.getElementById('violationsContainer');
            violationsContainer.innerHTML = '';
            
            if (analysisResult.violations.length === 0) {
                violationsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #d4edda; border-radius: 8px;">
                        <h3 style="color: #155724;">‚úÖ –ó–∞–º–µ—á–∞–Ω–∏–π –Ω–µ –≤—ã—è–≤–ª–µ–Ω–æ</h3>
                        <p>–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ì–û–°–¢</p>
                    </div>
                `;
            } else {
                analysisResult.violations.forEach((violation, index) => {
                    const violationElement = createViolationElement(violation, index + 1);
                    violationsContainer.appendChild(violationElement);
                });
            }
            
            // Set up download button
            document.getElementById('downloadReport').onclick = () => {
                downloadReport(result.red_pencil_report);
            };
            
            // Set up new check button
            document.getElementById('newCheck').onclick = resetForm;
        }

        function createViolationElement(violation, number) {
            const div = document.createElement('div');
            div.className = `violation-item ${violation.severity}`;
            
            const severityClass = `severity-${violation.severity}`;
            const severityText = getSeverityText(violation.severity);
            const severityColor = getSeverityColor(violation.severity);
            
            div.innerHTML = `
                <div class="violation-header">
                    <h4>–ó–∞–º–µ—á–∞–Ω–∏–µ ${number}: ${violation.violation}</h4>
                    <span class="violation-severity ${severityClass}" style="background: ${severityColor}">${severityText}</span>
                </div>
                <div class="violation-location">
                    <strong>üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> ${violation.location}
                </div>
                <div class="violation-rule">
                    <strong>üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:</strong> ${violation.rule_text}
                </div>
                ${violation.details ? `
                <div class="violation-quote">
                    <strong>üîç –î–µ—Ç–∞–ª–∏:</strong> ${violation.details}
                </div>
                ` : ''}
                <div class="violation-recommendation">
                    <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</strong> ${violation.recommendation}
                </div>
            `;
            
            return div;
        }

        function getSeverityText(severity) {
            const severityMap = {
                'high': '–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï',
                'medium': '–°–†–ï–î–ù–ï–ï',
                'low': '–ù–ò–ó–ö–û–ï'
            };
            return severityMap[severity] || '–ù–ï–ò–ó–í–ï–°–¢–ù–û';
        }

        function getSeverityColor(severity) {
            const colorMap = {
                'high': '#dc3545',
                'medium': '#ffc107', 
                'low': '#17a2b8'
            };
            return colorMap[severity] || '#6c757d';
        }

        async function downloadReport(redPencilReport) {
            try {
                const response = await fetch('/report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        red_pencil_report: redPencilReport
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Create and download text file
                    const blob = new Blob([result.report_text], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `normcontrol_report_${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('blocksSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function resetForm() {
            document.getElementById('uploadForm').style.display = 'block';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('blocksSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            currentAnalysisData = null;
        }
        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
function showBlocksInfo(blocksInfo) {
    const blocksSection = document.getElementById('blocksSection');
    
    if (blocksInfo && (blocksInfo.drawing || blocksInfo.description || blocksInfo.structure)) {
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–ª–æ–∫–æ–≤
        document.getElementById('drawingStats').innerHTML = `
            <strong>–°–∏–º–≤–æ–ª–æ–≤:</strong> ${blocksInfo.drawing?.length || 0}<br>
            <strong>–°–ª–æ–≤:</strong> ${blocksInfo.drawing?.split(/\s+/).filter(w => w).length || 0}
        `;
        
        document.getElementById('descriptionStats').innerHTML = `
            <strong>–°–∏–º–≤–æ–ª–æ–≤:</strong> ${blocksInfo.description?.length || 0}<br>
            <strong>–°–ª–æ–≤:</strong> ${blocksInfo.description?.split(/\s+/).filter(w => w).length || 0}
        `;
        
        document.getElementById('structureStats').innerHTML = `
            <strong>–°–∏–º–≤–æ–ª–æ–≤:</strong> ${blocksInfo.structure?.length || 0}<br>
            <strong>–°–ª–æ–≤:</strong> ${blocksInfo.structure?.split(/\s+/).filter(w => w).length || 0}
        `;
        
        // –ü—Ä–µ–≤—å—é –±–ª–æ–∫–æ–≤
        document.getElementById('drawingPreview').textContent = 
            blocksInfo.drawing?.substring(0, 200) + (blocksInfo.drawing?.length > 200 ? '...' : '') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
        document.getElementById('descriptionPreview').textContent = 
            blocksInfo.description?.substring(0, 200) + (blocksInfo.description?.length > 200 ? '...' : '') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
            
        document.getElementById('structurePreview').textContent = 
            blocksInfo.structure?.substring(0, 200) + (blocksInfo.structure?.length > 200 ? '...' : '') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        
        blocksSection.style.display = 'block';
    } else {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –±–ª–æ–∫–æ–≤, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
        blocksSection.style.display = 'none';
    }
}
    </script>
</body>
</html>